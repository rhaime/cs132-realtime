<!DOCTYPE html>
<html>

<head>
    <meta name="roomName" content="{{roomName}}">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Room: {{roomName}}</title>
    <script
      src="https://code.jquery.com/jquery-3.1.1.min.js"
      integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
      crossorigin="anonymous">
    </script>
</head>

<script src="/socket.io/socket.io.js"></script>

<script type="text/javascript">

  var socket = io.connect();
  var meta = document.querySelector('meta[name=roomName]');
  var roomName = meta.content;


$(document).ready(function(){

  var nickname = prompt('Enter a nickname: ');
  // replaced meta for roomName
  // sends roomname and nickname to the server
  socket.emit('join', roomName, nickname, function(messages){
    // in response, the server sent back an array of messages from that room
    // each item is a row
    // append those messages to show up
    // console.log(roomName)
    // console.log(nickname)
    // console.log(messages)


    for (var i=0; i<messages.length; i++){
      console.log("old messages added")
      var ul = $('#chats');
      ul.empty();

      var li = $('<li></li>');
      li.html(
        messages[i].nickname + ': ' + messages[i].body + ', ' + messages[i].time
      );

      ul.append(li);
    }

    });

});



  function changedNickname(){
    socket.on('changedNickname', function(members){
      newNickname = document.getElementById('newUsername').value;
    });
  }

  function message(){

    // socket.emit('message', function(message){
    //   var message = document.getElementById('messageField').value;
    //   console.log("inside")
    // });

    var message = document.getElementById('messageField').value;
    socket.emit('message', message);

    socket.on('message', function(nickname, message, time){
      console.log(message)
      var ul = $('#chats');
      ul.append($('<li></li>').text(nickname + ': ' + message + ', ' + time));
    });
  }


</script>

<body>

  <h1>Welcome to Chatroom {{roomName}}!</h1>

  <div id="changeUsernameContainer">
    <p>Change username: </p>
      <input type="text" name="username" id="newUsername" value="new name">
      <button value="Send" onclick="changedNickname()">Change</button>
  </div>

  <div id="sendMessageContainer">
      <p>Send message</p>
      <input type="text" name="message" id="messageField">
      <button value="Send" onclick="message()">Send</button>
  </div>



  <div>
      <p id="currentUsers"></p>
  </div>

  <div id="allChats">
    <ul id="chats"></ul>
  </div>

</body>

</html>
